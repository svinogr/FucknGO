{{ define "changeshoppage"}}
    {{ template "header" .}}
    <script src="/static/js/jquery-3.6.0.min.js" type="text/javascript"></script>

    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
    <script> $(document).ready(function () {

            $(".delete-button").click(function () {
                var id = $(this).prop("name");
                $.ajax({
                    'url': '/api/shop/' + id,
                    'method': 'DELETE',
                    'contentType': 'application/json',
                    statusCode: {
                        400: function () {
                            alert("неправельные данные");
                        },
                        302: function () {
                            window.location.href = "/api/login";
                        }
                    },
                    success: function (data) {
                        window.location.href = "/api/acountpage";
                    },
                });
            });

            $(".updateshop").click(function () {
                var form = $("#registration_form").serializeArray();
                var data = new Map();
                $(form).each(function (index, obj) {
                    data.set(obj.name, obj.value);
                });

                $.ajax({
                    'url': '/api/shop/' + data.get('id'),
                    'method': 'PUT',
                    'dataType': 'json',
                    'contentType': 'application/json',
                    'data': JSON.stringify({
                        "id": parseInt(data.get('id')),
                        "name": data.get('name'),
                        "address": data.get('address'),
                        "coord_lat": data.get('lat'),
                        "coord_lng": data.get('lng')
                    }),
                    statusCode: {
                        400: function () {
                            alert("неправельные данные");
                        },
                        302: function () {
                            window.location.href = "/api/login";
                        },
                        200: function () {
                            window.history.back();
                        }

                    },
                    success: function (data) {
                        history.back();
                    },
                });
            });
        });
    </script>
    </head>
    <body>

    <div class="container">
        <div class="mt-4">
            <h4>Настройка магазина</h4>

        </div>

        <div class="row">

            <div class="col-3 mt-4 mb-3">
                <div class="row">
                    <div class="col-12" style="background:#9fcdff; height: 200px">

                    </div>
                </div>
            </div>

            <div class="col-6">

                <div class="row  mt-4 mb-3">

                    <div class="col-12 ">
                        <form class="" id="registration_form" action="" method="post">
                            <input class="form-control" type="text" name="name" placeholder="название"
                                   value="{{ .Name}}">
                            <div class="input-group">
                                <input type="text" class="form-control" name="address" id="address" placeholder="адрес"
                                       readonly="readonly" value="{{ .Address}}">
                                <input type="text" class="form-control" name="id" id="id" readonly="readonly"
                                       value="{{ .Id}}">
                                <input type="text" class="form-control" name="lat" id="lat" readonly="readonly"
                                       value="{{ .CoordLat}}">
                                <input type="text" class="form-control" name="lng" id="lng" readonly="readonly"
                                       value="{{ .CoordLng}}">
                                <div class="input-group-append">
                                    <button class="btn btn-outline-secondary search" data-bs-toggle="modal"
                                            data-bs-target="#exampleModal" type="button">Выбрать
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

            </div>
            <div class="col-3 mt-4 mb-3">
                <div class="form-group">
                    <button class="btn btn-outline-danger btn-block form-control delete-button" id="btn_delete"
                            name="{{ .Id}}"
                            type="button">удалить
                    </button>
                    <br>
                    <a class="btn btn-outline-success btn-block form-control" onclick="history.back()">Назад</a>
                    <br>
                    <a class="btn btn-outline-success btn-block form-control updateshop" role="button">Сохранить</a>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Отметить адрес</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="container">
                        <div class="input-group-append">

                            <div class="input-group">
                                <input type="text" class="form-control" id="searchAddress" placeholder="адрес"
                                       readonly="readonly"> <br>
                            </div>
                        </div>
                        <br>
                        <script>
                            "use strict";
                            var geocoder;
                            var marker;
                            var map;
                            var inputAddress;
                            var lat;
                            var lng;

                            function initMap() {
                                //TODO сделать нормально чтоб при появлении окна маркеры стирались и ставились те что есть уже в адресе
                                inputAddress = document.getElementById("searchAddress");
                                geocoder = new google.maps.Geocoder();

                                map = new google.maps.Map(document.getElementById("map"), {
                                    zoom: 16,
                                    center: {lat: -33, lng: 151},
                                    mapTypeControl: true,
                                    mapTypeControlOptions: {
                                        style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
                                        mapTypeIds: ["roadmap", "terrain"],
                                    },
                                })

                                if (navigator.geolocation) {
                                    navigator.geolocation.getCurrentPosition(
                                        (position) => {
                                            const pos = {
                                                lat: position.coords.latitude,
                                                lng: position.coords.longitude,
                                            };
                                            map.setCenter(pos);
                                        },
                                        () => {

                                        }
                                    );
                                } else {
                                    alert("erro")
                                }

                                marker = new google.maps.Marker({
                                    position: {lat: parseFloat({{.CoordLat}}), lng: parseFloat({{.CoordLng}})},
                                    map: map
                                });
                                marker.setMap(map);


                                google.maps.event.addListener(map, 'click', function (event) {

                                    if (marker != null) {
                                        marker.setMap(null);
                                    }

                                    geocoder.geocode({
                                        'latLng': event.latLng
                                    }, function (results, status) {
                                        if (status == google.maps.GeocoderStatus.OK) {
                                            if (results[0]) {
                                                map.setCenter(results[0].geometry.location);
                                                marker = new google.maps.Marker({
                                                    position: results[0].geometry.location,
                                                    map: map
                                                });

                                                inputAddress.value = results[0].formatted_address;
                                                lng = results[0].geometry.location.lng();
                                                lat = results[0].geometry.location.lat();
                                            }
                                        }
                                    });
                                });
                            }

                            function setAddress() {
                                let address = document.getElementById("address");
                                let latInput = document.getElementById("lat");
                                let lngInput = document.getElementById("lng");

                                address.value = inputAddress.value;
                                latInput.value = lat;
                                lngInput.value = lng;
                            }
                        </script>

                        <div id="map" style="height: 300px; width: 300px; color: #005cbf"></div>

                        <script async
                                src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBIwzALxUPNbatRBj3Xi1Uhp0fFzwWNBkE&callback=initMap&libraries=&v=weekly">
                        </script>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="setAddress()" data-bs-dismiss="modal"> Ok
                    </button>
                </div>
            </div>
        </div>
    </div>

    </body>
    </html>
{{end}}